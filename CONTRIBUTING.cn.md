# è´¡çŒ®æŒ‡å—

é¦–å…ˆï¼Œæ„Ÿè°¢ä½ è€ƒè™‘ä¸º Sandbox Executor åšå‡ºè´¡çŒ®ï¼æ­£æ˜¯åƒä½ è¿™æ ·çš„äººè®©å®ƒæˆä¸ºäº†ä¸€ä¸ªå¦‚æ­¤å‡ºè‰²çš„å·¥å…·ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

Sandbox Executor æ—¨åœ¨ä¸ºåŸºäº WebAssembly çš„æ²™ç›’æä¾›é«˜çº§çš„ã€ä»¥å‡½æ•°ä¸ºä¸­å¿ƒçš„ APIã€‚

### è®¾è®¡ç†å¿µ

* **æ ‡å‡† I/O ä½œä¸ºé€šä¿¡æ¡¥æ¢**: ä½¿ç”¨ `stdin` ä½œä¸ºæ²™ç›’å†…çš„å‡½æ•°è¾“å…¥ï¼Œ`stdout` ä½œä¸ºå‡½æ•°è¾“å‡ºã€‚è¿™ç§è®¾è®¡ä½¿å¾—æ‰§è¡Œå™¨èƒ½å¤Ÿæ”¯æŒä»»æ„ç¼–ç¨‹è¯­è¨€ï¼Œå¹¶èƒ½æ›´æ–¹ä¾¿åœ°å¯¹å®é™…æ²™ç›’åº“è¿›è¡Œæ›´æ¢æˆ–è¿­ä»£ã€‚
* **SIP (Sandbox Input Protocol)**: ä¸ºäº†ç¡®ä¿é²æ£’æ€§å’Œæœªæ¥æ‰©å±•æ€§ï¼Œè¾“å…¥é‡‡ç”¨é•¿åº¦å‰ç¼€åè®®ï¼š
  * **ç¬¬ 1 å­—èŠ‚**: æ¨¡å¼ï¼ˆ`'A'` ä»£è¡¨åŸå­æ¨¡å¼ï¼Œ`'P'` ä»£è¡¨æŒä¹…æ¨¡å¼ï¼‰ã€‚
  * **ç¬¬ 2-5 å­—èŠ‚**: 4 å­—èŠ‚å¤§ç«¯åºæ•´æ•°ï¼Œè¡¨ç¤º JSON è´Ÿè½½çš„å­—èŠ‚é•¿åº¦ã€‚
  * **åç»­å­—èŠ‚**: JSON æ ¼å¼çš„è°ƒç”¨è¯·æ±‚ï¼ˆåŒ…å« `functionName`, `args`, `kwargs` ç­‰ï¼‰ã€‚
* **ä»£ç†/ç”¨æˆ·ä»£ç åˆ†ç¦»**: æ¯ç§è¯­è¨€éƒ½ç”±ä¸€ä¸ª `main` ä»£ç†ç¨‹åºè´Ÿè´£å¤„ç† SIP åè®®ï¼Œå¹¶åŠ¨æ€åŠ è½½å­˜æ”¾ç”¨æˆ·é€»è¾‘çš„ `user_code` æ–‡ä»¶ã€‚

### æŠ€æœ¯é™åˆ¶ä¸æœªæ¥è§„åˆ’

* **Stdin ç¼“å†²åŒºé™åˆ¶**: å½“å‰åº•å±‚çš„ `runFS` å®ç°å¯¹ `stdin` çš„ä¸€æ¬¡æ€§è¾“å…¥æœ‰ **8188 å­—èŠ‚ (8KB)** çš„é™åˆ¶ã€‚
* **æµå¼ Stdin**: æœªæ¥è®¡åˆ’é‡æ„ `runFS` ä»¥æ”¯æŒæµå¼ `stdin` APIï¼ˆä¾‹å¦‚é€šè¿‡ `ReadableStream`ï¼‰ã€‚

### PHP-CGI æ–¹æ¡ˆç»†èŠ‚ï¼šä¼ª Stdin (Pseudo-Stdin)

ç”±äº `php-cgi` åœ¨ WASM ç¯å¢ƒï¼ˆå¦‚ `@runno/sandbox`ï¼‰ä¸­å¯¹æ ‡å‡†è¾“å…¥æµçš„æ”¯æŒå­˜åœ¨é™åˆ¶ï¼š

1. **æµè¯»å–ä¸ç¨³å®š**: `php://stdin` å’Œ `php://input` åœ¨éƒ¨åˆ†è¿è¡Œæ—¶ä¸‹å¯èƒ½æ— æ³•æ­£ç¡®è¯»å–é€šè¿‡ `runFS` ä¼ é€’çš„ `stdin` å­—ç¬¦ä¸²ã€‚
2. **CGI åè®®å†²çª**: `php-cgi` å¾€å¾€æœŸæœ›ç¬¦åˆ CGI åè®®çš„è¾“å…¥ï¼Œè€Œç®€å•çš„å­—ç¬¦ä¸²å†™å…¥å¯èƒ½è¢«å¿½ç•¥ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
PHP ç”Ÿæˆå™¨é‡‡ç”¨äº†â€œä¼ª Stdinâ€æ–¹æ¡ˆã€‚åœ¨ç”Ÿæˆ `main.php` ä»£ç†æ–‡ä»¶æ—¶ï¼Œæ‰§è¡Œå™¨ä¼šå°† SIP åè®®æ•°æ®åŒ…è¿›è¡Œ Base64 ç¼–ç ï¼Œå¹¶å°†å…¶ä½œä¸ºå¸¸é‡å­—ç¬¦ä¸²åµŒå…¥åˆ°ä»£ç æ¨¡æ¿ä¸­ã€‚

* **ç”Ÿæˆé˜¶æ®µ**: `encodedData = base64_encode(SIP_Packet)` -> æ›¿æ¢æ¨¡æ¿ä¸­çš„ `{{STDIN_DATA}}`ã€‚
* **æ‰§è¡Œé˜¶æ®µ**: ä»£ç†ç¨‹åºç›´æ¥è°ƒç”¨ `base64_decode` è·å–è¾“å…¥ï¼Œè€Œä¸å†å°è¯•è¯»å–çœŸæ­£çš„æ ‡å‡†è¾“å…¥ã€‚
è¿™ç§æ–¹æ¡ˆåœ¨ç¡®ä¿å…¼å®¹æ€§çš„åŒæ—¶ï¼Œä¿æŒäº†ä»£ç†ç¨‹åºé€»è¾‘ä¸å…¶ä»–è¯­è¨€çš„ä¸€è‡´æ€§ã€‚

### æ ¸å¿ƒç»„ä»¶

1. **`SandboxExecutor` (src/executor.ts)**: ä¸»è¦å…¥å£ç‚¹ã€‚å®ƒç¼–æ’æ•´ä¸ªæ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼š
    * ç­¾åæ¨æ–­ã€‚
    * æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡ï¼ˆåŒ…å«ç”Ÿæˆä»£ç†æ–‡ä»¶å’Œç”¨æˆ·ä»£ç æ–‡ä»¶ï¼‰ã€‚
    * é€šè¿‡ `generateStdin` æ„å»º SIP æ•°æ®åŒ…ã€‚
    * é€šè¿‡ `@runno/sandbox` è¿›è¡Œ WASM æ‰§è¡Œã€‚
    * æ‰§è¡Œåçš„å˜æ›´æ£€æµ‹å’Œç»“æœè§£æã€‚

2. **ä»£ç ç”Ÿæˆå™¨ (src/generators/)**:
    * æ¯ç§è¯­è¨€éƒ½æœ‰ä¸€ä¸ª `CodeGenerator`ï¼Œå®ç° `generateFiles` å’Œ `generateStdin`ã€‚
    * ä»£ç†ç¨‹åºè´Ÿè´£ä» `stdin` è¯»å– SIP åŒ…ï¼Œè§£æå¹¶è°ƒç”¨ç›®æ ‡å‡½æ•°ï¼Œå°†ç»“æœåºåˆ—åŒ–åˆ° `stdout`ã€‚
    * **é™æ€ä»£ç†ä¸åŠ¨æ€è½¬å‘**: å¯¹äºä¸æ”¯æŒåå°„çš„è¯­è¨€ï¼ˆå¦‚ C/C++ï¼‰ï¼Œç”Ÿæˆå™¨ä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ª `dispatcher` èƒ¶æ°´å±‚æ¥å¤„ç†å‡½æ•°åˆ†å‘ã€‚

3. **ç­¾åæ¨æ–­ (src/inference/engine.ts)**:
    * ä½¿ç”¨é™æ€åˆ†æï¼ˆåŸºäºæ­£åˆ™ï¼‰å’Œè¯­è¨€çº¦å®šæ¥ç¡®å®šå‡½æ•°å‚æ•°ã€‚
    * è¿™ä½¿å¾—æ‰§è¡Œå™¨èƒ½å¤Ÿæ­£ç¡®åœ°å°† `args` å’Œ `kwargs` æ˜ å°„åˆ°åº•å±‚è¯­è¨€çš„å‡½æ•°è°ƒç”¨è¯­æ³•ã€‚

4. **æ–‡ä»¶ç³»ç»Ÿç®¡ç† (src/fs/)**:
    * **`FSBuilder`**: æ„å»ºåˆå§‹çš„ `WASIFS` å¯¹è±¡ã€‚
    * **`FileSystemDiffer`**: é€šè¿‡åœ¨æ‰§è¡Œå‰æ‹æ‘„å¿«ç…§å¹¶ä¸ WASM è¿è¡Œæ—¶çš„ç»“æœè¿›è¡Œå¯¹æ¯”æ¥å¤„ç†å˜æ›´æ£€æµ‹ã€‚è¿™ç§åŸºäºå¿«ç…§çš„æ–¹æ³•ç¡®ä¿äº†ä¸ WASM Worker çš„å…¼å®¹æ€§ï¼ˆProxy å¯¹è±¡æ— æ³•è¢«å…‹éš†ï¼‰ã€‚
    * **`SyncManager`**: å°†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´åŒæ­¥å›çœŸå®ç£ç›˜ï¼Œå¹¶æ‰§è¡Œé…ç½®çš„æƒé™ã€‚
    * **`PermissionResolver`**: è®¡ç®—åŸºäº glob çš„è§„åˆ™ä»¥å…è®¸æˆ–æ‹’ç»æ–‡ä»¶æ“ä½œã€‚

## ğŸš€ å¼€å‘æµç¨‹

### å‰ææ¡ä»¶

* Node.js >= 20.11.1
* pnpm

### è®¾ç½®

```bash
git clone https://github.com/isdk/sandbox-executor.js.git
cd sandbox-executor.js
pnpm install
```

### æ„å»º

```bash
pnpm run build
```

### æµ‹è¯•

æˆ‘ä»¬ä½¿ç”¨ [Vitest](https://vitest.dev/) è¿›è¡Œæµ‹è¯•ã€‚

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¦†ç›–ç‡
pnpm test:coverage

# ä»…è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆéœ€è¦ç½‘ç»œ/WASM è¿è¡Œæ—¶ï¼‰
npx vitest test/integration
```

## ğŸŒ æ·»åŠ æ–°è¯­è¨€æ”¯æŒ

è¦æ·»åŠ æ–°è¯­è¨€ï¼Œä½ éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ·»åŠ è¯­è¨€ç±»å‹**: æ›´æ–° `src/types/request.ts` ä¸­çš„ `SupportedLanguage`ã€‚
2. **å®ç°ç”Ÿæˆå™¨**: åˆ›å»º `src/generators/<language>.ts` å¹¶ç»§æ‰¿ `CodeGenerator`ã€‚
    * å®ç° `generateWrapper`: åˆ›å»ºè°ƒç”¨ç”¨æˆ·å‡½æ•°å¹¶åœ¨æ ‡è®°ä¹‹é—´æ‰“å° JSON è¾“å‡ºçš„ä»£ç ã€‚
    * å®ç° `serialize`: å¦‚ä½•å°† JS ç±»å‹è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€çš„å­—é¢é‡ã€‚
3. **æ³¨å†Œç”Ÿæˆå™¨**: å°†ä½ çš„ç”Ÿæˆå™¨æ·»åŠ åˆ° `src/generators/index.ts` ä¸­çš„æ˜ å°„ä¸­ã€‚
    * å¦‚æœ Runno çš„è¿è¡Œæ—¶åç§°ä¸ä½ çš„è¯­è¨€åç§°ä¸åŒï¼ˆä¾‹å¦‚ `php` -> `php-cgi`ï¼‰ï¼Œè¯·æ›´æ–° `getRuntime`ã€‚
    * **C/C++ æ³¨æ„äº‹é¡¹**: å½“å‰æ²™ç›’ç¯å¢ƒä¸­çš„ `clang` å’Œ `clangpp` å­˜åœ¨ä¸€äº›é™åˆ¶ï¼š
        * **å¼‚å¸¸**: å¼‚å¸¸å·²è¢«ç¦ç”¨ã€‚ä¸è¦åœ¨åŒ…è£…ä»£ç ä¸­ä½¿ç”¨ `try-catch` å—ã€‚
        * **æ ‡å‡†**: ä½¿ç”¨å…¼å®¹ C++11 çš„ä»£ç ã€‚é¿å…ä½¿ç”¨ C++14/17/20 çš„ç‰¹æ€§ï¼Œå¦‚ `if constexpr` æˆ–ç±»å‹ç‰¹å¾å˜é‡ï¼ˆå¦‚ `is_same_v`ï¼‰ã€‚å¦‚æœéœ€è¦ï¼Œè¯·ä½¿ç”¨ä¼ ç»Ÿçš„æ¨¡æ¿ç‰¹åŒ–å’Œ `std::enable_if`ã€‚
4. **æ·»åŠ æ¨æ–­é€»è¾‘**: æ›´æ–° `src/inference/engine.ts`ã€‚
    * å®ç° `infer<Language>` æ–¹æ³•æ¥è§£æå‡½æ•°ç­¾åã€‚
    * ä½¿ç”¨æ–°è¯­è¨€çš„é»˜è®¤è¡Œä¸ºæ›´æ–° `getConvention`ã€‚
5. **æ·»åŠ æµ‹è¯•**:
    * åœ¨ `test/unit/generators/` ä¸­æ·»åŠ ç”Ÿæˆå™¨çš„å•å…ƒæµ‹è¯•ã€‚
    * åœ¨ `test/unit/inference-engine.test.ts` ä¸­æ·»åŠ æ¨æ–­æµ‹è¯•ã€‚
    * åœ¨ `test/integration/real-environment.test.ts` ä¸­æ·»åŠ é›†æˆæµ‹è¯•ã€‚

## ğŸ“ æ–‡ä»¶ç³»ç»Ÿè¿½è¸ªè¯¦æƒ…

ä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸºäº `Proxy` çš„æ–¹æ³• (`TrackedFileSystem`)ã€‚ä½†æ˜¯ï¼Œç”±äº `@runno/sandbox` åœ¨ Worker ä¸­æ‰§è¡Œ WASMï¼Œæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡å¿…é¡»é€šè¿‡ç»“æ„åŒ–å…‹éš†ç®—æ³•è¿›è¡Œå…‹éš†ã€‚ç”±äº `Proxy` å¯¹è±¡æ— æ³•è¢«å…‹éš†ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°äº† `FileSystemDiffer`ã€‚

`FileSystemDiffer` çš„å·¥ä½œåŸç†ï¼š

1. åœ¨æ‰§è¡Œå‰å¯¹ `WASIFS` è¿›è¡Œæ·±æ‹·è´ã€‚
2. å°†çº¯ `WASIFS` å¯¹è±¡ä¼ é€’ç»™æ²™ç›’ã€‚
3. å°†æ²™ç›’è¿”å›çš„ `WASIFS` ä¸åˆå§‹å¿«ç…§è¿›è¡Œå¯¹æ¯”ã€‚

è¿™ç§æ–¹æ³•å¯¹äºè·¨çº¿ç¨‹é€šä¿¡æ›´åŠ å¥å£®ï¼Œå¹¶ç¡®ä¿æ•è·æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬ WASI è¿è¡Œæ—¶æœ¬èº«æ‰€åšçš„å˜æ›´ï¼‰ã€‚
