# è´¡çŒ®æŒ‡å—

é¦–å…ˆï¼Œæ„Ÿè°¢ä½ è€ƒè™‘ä¸º Sandbox Executor åšå‡ºè´¡çŒ®ï¼æ­£æ˜¯åƒä½ è¿™æ ·çš„äººè®©å®ƒæˆä¸ºäº†ä¸€ä¸ªå¦‚æ­¤å‡ºè‰²çš„å·¥å…·ã€‚

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

Sandbox Executor æ—¨åœ¨ä¸ºåŸºäº WebAssembly çš„æ²™ç›’æä¾›é«˜çº§çš„ã€ä»¥å‡½æ•°ä¸ºä¸­å¿ƒçš„ APIã€‚

### æ ¸å¿ƒç»„ä»¶

1. **`SandboxExecutor` (src/executor.ts)**: ä¸»è¦å…¥å£ç‚¹ã€‚å®ƒç¼–æ’æ•´ä¸ªæ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼š
    * ç­¾åæ¨æ–­ã€‚
    * ä»£ç åŒ…è£…ã€‚
    * æ–‡ä»¶ç³»ç»Ÿå‡†å¤‡ã€‚
    * é€šè¿‡ `@runno/sandbox` è¿›è¡Œ WASM æ‰§è¡Œã€‚
    * æ‰§è¡Œåçš„å˜æ›´æ£€æµ‹å’Œæ¸…ç†ã€‚

2. **ä»£ç ç”Ÿæˆå™¨ (src/generators/)**:
    * æ¯ç§è¯­è¨€éƒ½æœ‰ä¸€ä¸ª `CodeGenerator`ï¼Œè´Ÿè´£å°†ç”¨æˆ·ä»£ç åŒ…è£…åˆ°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ã€‚
    * åŒ…è£…ä»£ç è´Ÿè´£è°ƒç”¨ç›®æ ‡å‡½æ•°ï¼Œæ•è·ç»“æœ/é”™è¯¯ï¼Œå¹¶ä½¿ç”¨ç‰¹å®šçš„æ ‡è®° (`__SANDBOX_RESULT_START__`) å°†å…¶åºåˆ—åŒ–åˆ° `stdout`ã€‚

3. **ç­¾åæ¨æ–­ (src/inference/engine.ts)**:
    * ä½¿ç”¨é™æ€åˆ†æï¼ˆåŸºäºæ­£åˆ™ï¼‰å’Œè¯­è¨€çº¦å®šæ¥ç¡®å®šå‡½æ•°å‚æ•°ã€‚
    * è¿™ä½¿å¾—æ‰§è¡Œå™¨èƒ½å¤Ÿæ­£ç¡®åœ°å°† `args` å’Œ `kwargs` æ˜ å°„åˆ°åº•å±‚è¯­è¨€çš„å‡½æ•°è°ƒç”¨è¯­æ³•ã€‚

4. **æ–‡ä»¶ç³»ç»Ÿç®¡ç† (src/fs/)**:
    * **`FSBuilder`**: æ„å»ºåˆå§‹çš„ `WASIFS` å¯¹è±¡ã€‚
    * **`FileSystemDiffer`**: é€šè¿‡åœ¨æ‰§è¡Œå‰æ‹æ‘„å¿«ç…§å¹¶ä¸ WASM è¿è¡Œæ—¶çš„ç»“æœè¿›è¡Œå¯¹æ¯”æ¥å¤„ç†å˜æ›´æ£€æµ‹ã€‚è¿™ç§åŸºäºå¿«ç…§çš„æ–¹æ³•ç¡®ä¿äº†ä¸ WASM Worker çš„å…¼å®¹æ€§ï¼ˆProxy å¯¹è±¡æ— æ³•è¢«å…‹éš†ï¼‰ã€‚
    * **`SyncManager`**: å°†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿçš„å˜æ›´åŒæ­¥å›çœŸå®ç£ç›˜ï¼Œå¹¶æ‰§è¡Œé…ç½®çš„æƒé™ã€‚
    * **`PermissionResolver`**: è®¡ç®—åŸºäº glob çš„è§„åˆ™ä»¥å…è®¸æˆ–æ‹’ç»æ–‡ä»¶æ“ä½œã€‚

## ğŸš€ å¼€å‘æµç¨‹

### å‰ææ¡ä»¶

* Node.js >= 20.11.1
* pnpm

### è®¾ç½®

```bash
git clone https://github.com/isdk/sandbox-executor.js.git
cd sandbox-executor.js
pnpm install
```

### æ„å»º

```bash
pnpm run build
```

### æµ‹è¯•

æˆ‘ä»¬ä½¿ç”¨ [Vitest](https://vitest.dev/) è¿›è¡Œæµ‹è¯•ã€‚

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¦†ç›–ç‡
pnpm test:coverage

# ä»…è¿è¡Œé›†æˆæµ‹è¯•ï¼ˆéœ€è¦ç½‘ç»œ/WASM è¿è¡Œæ—¶ï¼‰
npx vitest test/integration
```

## ğŸŒ æ·»åŠ æ–°è¯­è¨€æ”¯æŒ

è¦æ·»åŠ æ–°è¯­è¨€ï¼Œä½ éœ€è¦æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **æ·»åŠ è¯­è¨€ç±»å‹**: æ›´æ–° `src/types/request.ts` ä¸­çš„ `SupportedLanguage`ã€‚
2. **å®ç°ç”Ÿæˆå™¨**: åˆ›å»º `src/generators/<language>.ts` å¹¶ç»§æ‰¿ `CodeGenerator`ã€‚
    * å®ç° `generateWrapper`: åˆ›å»ºè°ƒç”¨ç”¨æˆ·å‡½æ•°å¹¶åœ¨æ ‡è®°ä¹‹é—´æ‰“å° JSON è¾“å‡ºçš„ä»£ç ã€‚
    * å®ç° `serialize`: å¦‚ä½•å°† JS ç±»å‹è½¬æ¢ä¸ºç›®æ ‡è¯­è¨€çš„å­—é¢é‡ã€‚
3. **æ³¨å†Œç”Ÿæˆå™¨**: å°†ä½ çš„ç”Ÿæˆå™¨æ·»åŠ åˆ° `src/generators/index.ts` ä¸­çš„æ˜ å°„ä¸­ã€‚
    * å¦‚æœ Runno çš„è¿è¡Œæ—¶åç§°ä¸ä½ çš„è¯­è¨€åç§°ä¸åŒï¼ˆä¾‹å¦‚ `php` -> `php-cgi`ï¼‰ï¼Œè¯·æ›´æ–° `getRuntime`ã€‚
    * **C/C++ æ³¨æ„äº‹é¡¹**: å½“å‰æ²™ç›’ç¯å¢ƒä¸­çš„ `clang` å’Œ `clangpp` å­˜åœ¨ä¸€äº›é™åˆ¶ï¼š
        * **å¼‚å¸¸**: å¼‚å¸¸å·²è¢«ç¦ç”¨ã€‚ä¸è¦åœ¨åŒ…è£…ä»£ç ä¸­ä½¿ç”¨ `try-catch` å—ã€‚
        * **æ ‡å‡†**: ä½¿ç”¨å…¼å®¹ C++11 çš„ä»£ç ã€‚é¿å…ä½¿ç”¨ C++14/17/20 çš„ç‰¹æ€§ï¼Œå¦‚ `if constexpr` æˆ–ç±»å‹ç‰¹å¾å˜é‡ï¼ˆå¦‚ `is_same_v`ï¼‰ã€‚å¦‚æœéœ€è¦ï¼Œè¯·ä½¿ç”¨ä¼ ç»Ÿçš„æ¨¡æ¿ç‰¹åŒ–å’Œ `std::enable_if`ã€‚
4. **æ·»åŠ æ¨æ–­é€»è¾‘**: æ›´æ–° `src/inference/engine.ts`ã€‚
    * å®ç° `infer<Language>` æ–¹æ³•æ¥è§£æå‡½æ•°ç­¾åã€‚
    * ä½¿ç”¨æ–°è¯­è¨€çš„é»˜è®¤è¡Œä¸ºæ›´æ–° `getConvention`ã€‚
5. **æ·»åŠ æµ‹è¯•**:
    * åœ¨ `test/unit/generators/` ä¸­æ·»åŠ ç”Ÿæˆå™¨çš„å•å…ƒæµ‹è¯•ã€‚
    * åœ¨ `test/unit/inference-engine.test.ts` ä¸­æ·»åŠ æ¨æ–­æµ‹è¯•ã€‚
    * åœ¨ `test/integration/real-environment.test.ts` ä¸­æ·»åŠ é›†æˆæµ‹è¯•ã€‚

## ğŸ“ æ–‡ä»¶ç³»ç»Ÿè¿½è¸ªè¯¦æƒ…

ä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨åŸºäº `Proxy` çš„æ–¹æ³• (`TrackedFileSystem`)ã€‚ä½†æ˜¯ï¼Œç”±äº `@runno/sandbox` åœ¨ Worker ä¸­æ‰§è¡Œ WASMï¼Œæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡å¿…é¡»é€šè¿‡ç»“æ„åŒ–å…‹éš†ç®—æ³•è¿›è¡Œå…‹éš†ã€‚ç”±äº `Proxy` å¯¹è±¡æ— æ³•è¢«å…‹éš†ï¼Œæˆ‘ä»¬åˆ‡æ¢åˆ°äº† `FileSystemDiffer`ã€‚

`FileSystemDiffer` çš„å·¥ä½œåŸç†ï¼š

1. åœ¨æ‰§è¡Œå‰å¯¹ `WASIFS` è¿›è¡Œæ·±æ‹·è´ã€‚
2. å°†çº¯ `WASIFS` å¯¹è±¡ä¼ é€’ç»™æ²™ç›’ã€‚
3. å°†æ²™ç›’è¿”å›çš„ `WASIFS` ä¸åˆå§‹å¿«ç…§è¿›è¡Œå¯¹æ¯”ã€‚

è¿™ç§æ–¹æ³•å¯¹äºè·¨çº¿ç¨‹é€šä¿¡æ›´åŠ å¥å£®ï¼Œå¹¶ç¡®ä¿æ•è·æ‰€æœ‰å˜æ›´ï¼ˆåŒ…æ‹¬ WASI è¿è¡Œæ—¶æœ¬èº«æ‰€åšçš„å˜æ›´ï¼‰ã€‚
